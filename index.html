<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RPG Workout Timer v2</title>
    <style>
        :root {
            --primary: #8b5cf6;   /* Violet */
            --secondary: #ec4899; /* Pink */
            --accent: #f59e0b;    /* Amber (Gold) */
            --bg: #0f172a;
            --card: #1e293b;
            --text: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            user-select: none;
        }

        .container {
            background-color: var(--card);
            padding: 2rem;
            border-radius: 24px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            width: 360px;
            text-align: center;
            border: 1px solid #334155;
        }

        /* --- HUD (Level & Streak) --- */
        .hud {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 15px;
        }

        .level-badge {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            padding: 4px 12px;
            border-radius: 99px;
            font-weight: 800;
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }

        .streak-badge {
            color: var(--accent);
            font-weight: bold;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .streak-badge.active { animation: pulse-gold 2s infinite; }

        .xp-bar-container {
            width: 100%;
            height: 8px;
            background-color: #334155;
            border-radius: 99px;
            overflow: hidden;
            margin-top: 10px;
        }

        .xp-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
            width: 0%;
            transition: width 0.5s ease;
        }

        .xp-text {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 6px;
            display: block;
            text-align: right;
            font-family: monospace;
        }

        /* --- TIMER --- */
        .timer-wrapper {
            position: relative;
            margin: 30px 0;
        }
        .timer-display {
            font-size: 4.5rem;
            font-weight: 800;
            font-variant-numeric: tabular-nums;
            line-height: 1;
            color: white;
            text-shadow: 0 0 20px rgba(139, 92, 246, 0.2);
        }
        .timer-label {
            font-size: 1rem;
            color: var(--primary);
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        /* --- PRESETS --- */
        .presets {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin-bottom: 20px;
        }
        .chip {
            background: #334155;
            color: #cbd5e1;
            border: none;
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chip:hover { background: #475569; color: white; }
        .chip:active { transform: scale(0.95); }

        /* --- INPUTS --- */
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            background: #0f172a;
            padding: 8px;
            border-radius: 12px;
        }
        input {
            background: transparent;
            border: none;
            color: white;
            padding: 5px;
            font-size: 1rem;
            font-weight: bold;
            text-align: center;
            width: 100%;
            outline: none;
        }
        input:focus { color: var(--primary); }
        /* Remove arrows */
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* --- CONTROLS --- */
        .controls {
            display: flex;
            gap: 10px;
        }
        .btn-main {
            flex: 2;
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 4px 0 #5b21b6; /* 3D effect */
            transition: transform 0.1s, box-shadow 0.1s;
        }
        .btn-main:active { transform: translateY(4px); box-shadow: 0 0 0 #5b21b6; }
        
        .btn-stop { background: #ef4444; box-shadow: 0 4px 0 #991b1b; display: none; }
        .btn-stop:active { transform: translateY(4px); box-shadow: 0 0 0 #991b1b; }

        .btn-reset {
            flex: 1;
            background: #334155;
            color: white;
            border: none;
            padding: 16px;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
        }

        .message { height: 20px; margin-top: 15px; font-size: 0.85rem; color: var(--accent); font-weight: bold; }

        @keyframes pulse-gold { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
    </style>
</head>
<body>

<div class="container">
    <div class="hud">
        <span class="level-badge" id="levelDisplay">LVL 1</span>
        <div class="streak-badge active" title="Bonus XP Multiplier!">
            <span id="streakIcon">üî•</span>
            <span id="streakCount">0</span>
            <span style="font-size:0.7em; opacity:0.7;">Day Streak</span>
        </div>
    </div>
    
    <div class="xp-bar-container">
        <div class="xp-bar-fill" id="xpBar"></div>
    </div>
    <span class="xp-text" id="xpText">0 / 100 XP</span>

    <div class="timer-wrapper">
        <div class="timer-label" id="timerLabel">READY</div>
        <div class="timer-display" id="timer">00:00</div>
    </div>

    <div class="presets">
        <button class="chip" onclick="setPreset('Plank', 60)">üí™ Plank 1m</button>
        <button class="chip" onclick="setPreset('Tabata', 240)">‚è±Ô∏è Tabata 4m</button>
        <button class="chip" onclick="setPreset('Focus', 1500)">üß† Focus 25m</button>
    </div>

    <div class="input-group" id="setupArea">
        <input type="text" id="exerciseName" value="Custom Workout">
        <div style="width: 1px; background: #334155;"></div>
        <input type="number" id="durationInput" value="60">
        <span style="color:#64748b; padding:5px; font-size:0.8rem; display:flex; align-items:center;">s</span>
    </div>

    <div class="controls">
        <button class="btn-main" id="startBtn" onclick="startTimer()">START QUEST</button>
        <button class="btn-main btn-stop" id="stopBtn" onclick="stopTimer()">GIVE UP</button>
        <button class="btn-reset" onclick="resetTimer()">RESET</button>
    </div>

    <div class="message" id="messageBox"></div>
</div>

<script>
    // --- STATE ---
    let timerInterval;
    let totalTime = 60;
    let timeLeft = 60;
    let isRunning = false;
    
    let player = JSON.parse(localStorage.getItem('rpg_player_v2')) || {
        xp: 0,
        level: 1,
        xpToNext: 100,
        streak: 0,
        lastLog: null // stores date string "YYYY-MM-DD"
    };

    // --- SOUND ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function beep(freq = 440, type = 'sine', len = 0.1) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.type = type;
        osc.frequency.value = freq;
        osc.connect(gain);
        gain.connect(audioCtx.destination);
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.00001, audioCtx.currentTime + len);
        osc.stop(audioCtx.currentTime + len);
    }

    // --- LOGIC ---
    function checkStreak() {
        const today = new Date().toISOString().split('T')[0];
        
        if (player.lastLog === today) return; // Already logged today

        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yStr = yesterday.toISOString().split('T')[0];

        if (player.lastLog === yStr) {
            player.streak++; // Continued streak
        } else {
            player.streak = 1; // Broken streak or new start
        }
        player.lastLog = today;
        saveData();
    }

    function updateHUD() {
        document.getElementById('levelDisplay').innerText = `LVL ${player.level}`;
        document.getElementById('xpText').innerText = `${Math.floor(player.xp)} / ${player.xpToNext} XP`;
        document.getElementById('streakCount').innerText = player.streak;
        
        const pct = Math.min(100, (player.xp / player.xpToNext) * 100);
        document.getElementById('xpBar').style.width = `${pct}%`;
    }

    function addXP(baseAmount) {
        // Bonus Calculation: 10% bonus per streak day (capped at 100% bonus)
        const bonusMult = 1 + (Math.min(player.streak, 10) * 0.1);
        const finalXP = Math.floor(baseAmount * bonusMult);
        
        player.xp += finalXP;
        
        // Level Up Logic
        if (player.xp >= player.xpToNext) {
            player.level++;
            player.xp -= player.xpToNext;
            player.xpToNext = Math.floor(player.xpToNext * 1.4);
            
            // Level Up FX
            beep(600, 'square', 0.1); setTimeout(() => beep(800, 'square', 0.2), 150);
            document.getElementById('levelDisplay').style.transform = "scale(1.5)";
            setTimeout(() => document.getElementById('levelDisplay').style.transform = "scale(1)", 500);
            document.getElementById('messageBox').innerText = `LEVEL UP! +${finalXP} XP (x${bonusMult.toFixed(1)} Bonus)`;
        } else {
            document.getElementById('messageBox').innerText = `Completed! +${finalXP} XP`;
        }
        
        checkStreak(); // Update streak status
        saveData();
        updateHUD();
    }

    function saveData() {
        localStorage.setItem('rpg_player_v2', JSON.stringify(player));
    }

    // --- TIMER FUNCTIONS ---
    function formatTime(s) {
        const m = Math.floor(s / 60).toString().padStart(2, '0');
        const sc = (s % 60).toString().padStart(2, '0');
        return `${m}:${sc}`;
    }

    function setPreset(name, time) {
        if(isRunning) return;
        document.getElementById('exerciseName').value = name;
        document.getElementById('durationInput').value = time;
        document.getElementById('timer').innerText = formatTime(time);
        document.getElementById('timerLabel').innerText = name.toUpperCase();
        timeLeft = time;
    }

    function startTimer() {
        if (isRunning) return;
        
        // Input Validation
        const val = parseInt(document.getElementById('durationInput').value);
        if(!val || val <= 0) return;
        
        totalTime = val;
        timeLeft = val;
        
        document.getElementById('timerLabel').innerText = document.getElementById('exerciseName').value.toUpperCase();
        
        isRunning = true;
        toggleControls(true);
        beep(440, 'sine', 0.1);

        timerInterval = setInterval(() => {
            timeLeft--;
            document.getElementById('timer').innerText = formatTime(timeLeft);
            if (timeLeft <= 0) finishTimer();
        }, 1000);
    }

    function stopTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        toggleControls(false);
        document.getElementById('timerLabel').innerText = "PAUSED";
    }

    function finishTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        toggleControls(false);
        
        document.getElementById('timer').innerText = "DONE";
        // Victory Fanfare
        beep(523, 'triangle', 0.1);
        setTimeout(() => beep(659, 'triangle', 0.1), 150);
        setTimeout(() => beep(784, 'triangle', 0.4), 300);
        
        addXP(totalTime);
    }

    function resetTimer() {
        clearInterval(timerInterval);
        isRunning = false;
        toggleControls(false);
        const val = parseInt(document.getElementById('durationInput').value) || 60;
        document.getElementById('timer').innerText = formatTime(val);
        document.getElementById('timerLabel').innerText = "READY";
        document.getElementById('messageBox').innerText = "";
    }

    function toggleControls(active) {
        document.getElementById('startBtn').style.display = active ? 'none' : 'block';
        document.getElementById('stopBtn').style.display = active ? 'block' : 'none';
        document.getElementById('setupArea').style.opacity = active ? '0.3' : '1';
        document.getElementById('setupArea').style.pointerEvents = active ? 'none' : 'auto';
    }

    // Init
    updateHUD();
    resetTimer();
</script>

</body>
</html>
